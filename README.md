# AWS Custom Metric Alarm

This repo contains Terraform code to create an alarm from a custom metric
generated by a Lambda function. The Lambda function is triggered periodically
by an EventBridge (formerly CloudWatch Events) event rule.

When initially deployed this module zips the function's source code and uploads
the zip file to S3. The Lambda function is then launched with the zipped
package. In subsequent runs, if a code change is detected this module updates
the package in S3 and triggers a re-launch of the Lambda function.

## Design

The components in this module are shown below:

![layout](https://raw.githubusercontent.com/conrad-mukai/terraform-aws-lambda-alarm/master/images/aws-lambda-alarm.png)

The blue lines indicate actions performed at deploy time. The black lines are
for actions performed every time the event rule is triggered. The red lines are
for actions performed every time an alarm is triggered.

## Preparation

Two resources need to be created before running this code:
1. an S3 bucket for storing the zip file for the Lambda function; and
1. an IAM role granting the Lambda function runtime access.

The S3 bucket should optionally enable versioning so versions of the code are
archived.

At a minimum the IAM role should allow `cloudwatch:PutMetricData`. If logging
is desired then `logs:CreateLogGroup`, `logs:CreateLogStream`, and
`logs:PutLogEvents` should be added to the role.

## Deployment

The initial deployment will create the requisite resources and record state.
Should the Lambda function code change, subsequent runs will detect this and
publish a new version of the Lambda function.

## Rollback

The module publishes versions of the Lambda function, so rollback simply
requires triggering an earlier version of the function. To do this go to the
EventBridge console and edit the rule. In the Targets section select an earlier
version of the Lambda function. This is shown below:

![EventBridge Console](https://raw.githubusercontent.com/conrad-mukai/terraform-aws-lambda-alarm/master/images/eventbridge-console.png)

This will redirect events to the earlier version. You can also perform some
cleanup in the Lambda console. The unqualified version that you just
deactivated will still show the EventBridge event triggering the version of the
function, though when examining the event details you will see an error.
You can delete this trigger.

When the code is patched you can run the Terraform code and it will
upload a new zip file and launch a new unqualified version of the Lambda
function. You can delete the triggering event for the rollback version in the
Lambda console if you wish.

## Example

Refer to the `examples/rube-goldberg-alarm-clock` directory to see a working
invocation of this module.
